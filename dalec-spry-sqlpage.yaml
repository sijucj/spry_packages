# syntax=ghcr.io/azure/dalec/frontend:latest
# DALEC config for packaging spry-sqlpage and spry-runbook binaries

name: spry-sqlpage
version: 0.1.1
revision: 1
packager: Spry Team
vendor: Spry
license: MIT
description: Spry CLI tools - SQLPage web framework and Runbook execution
website: https://github.com/programmablemd/spry

sources:
  src:
    context: {}

# No compilation - just package existing binaries from build context
build:
  env:
    # Disable stripping to preserve Deno binary metadata
    DEB_BUILD_OPTIONS: "nostrip"
  steps:
    - command: |
        set -ex
        # Debug: Check what files are available
        pwd
        ls -la
        find . -name "*spry-*" -type f

        # Binaries provided by workflow
        # The source name "src" becomes nested: src/src/src/
        ls -la src/src/src/spry-sqlpage
        ls -la src/src/src/spry-runbook
        # Use cp -p to preserve permissions and attributes
        cp -p src/src/src/spry-sqlpage ./spry-sqlpage
        cp -p src/src/src/spry-runbook ./spry-runbook
        chmod +x spry-sqlpage spry-runbook

        # Verify the binaries work before packaging
        file ./spry-sqlpage
        file ./spry-runbook
        ls -lh ./spry-sqlpage ./spry-runbook

artifacts:
  binaries:
    spry-sqlpage:
    spry-runbook:

tests:
  - name: Check spry-sqlpage binary exists
    steps:
      - command: test -f /usr/bin/spry-sqlpage

  - name: Verify spry-sqlpage is executable
    steps:
      - command: test -x /usr/bin/spry-sqlpage

  - name: Check spry-runbook binary exists
    steps:
      - command: test -f /usr/bin/spry-runbook

  - name: Verify spry-runbook is executable
    steps:
      - command: test -x /usr/bin/spry-runbook

targets:
  jammy:          # Ubuntu 22.04 DEB
    dependencies:
      runtime:
        ca-certificates:
  bookworm:       # Debian 12 DEB
    dependencies:
      runtime:
        ca-certificates:
  windowscross:   # Windows cross-compilation

