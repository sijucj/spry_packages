# syntax=ghcr.io/azure/dalec/frontend:latest
# DALEC config for packaging spry binary

name: spry
version: 0.111.0
revision: 1
packager: Spry Team
vendor: Spry
license: MIT
description: Spry CLI - A declarative web application framework
website: https://github.com/programmablemd/spry

sources:
  src:
    context: {}

# No compilation - just package existing binary from build context
build:
  env:
    # Disable stripping to preserve Deno binary metadata
    DEB_BUILD_OPTIONS: "nostrip"
  steps:
    - command: |
        set -ex
        # Debug: Check what files are available
        pwd
        ls -la
        find . -name "*spry*" -type f

        # Binary provided by workflow
        # The source name "src" becomes nested: src/src/src/
        ls -la src/src/src/spry
        # Use cp -p to preserve permissions and attributes
        cp -p src/src/src/spry ./spry
        chmod +x spry

        # Handle man page
        cp src/src/src/man/spry.1 ./spry.1

        # Verify the binary works before packaging
        file ./spry
        ls -lh ./spry

artifacts:
  binaries:
    spry:
  manpages:
    spry.1:

tests:
  - name: Check spry binary exists
    steps:
      - command: test -f /usr/bin/spry

  - name: Verify spry is executable
    steps:
      - command: test -x /usr/bin/spry

targets:
  jammy: # Ubuntu 22.04 DEB
    dependencies:
      runtime:
        ca-certificates:
  bookworm: # Debian 12 DEB
    dependencies:
      runtime:
        ca-certificates:
  windowscross: # Windows cross-compilation
